<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZenTrader Pro ‚Äî Voice Live Fill</title>
<style>
  :root{
    --bg:#000000;         /* black app background */
    --card:#0f172a;       /* slate card */
    --text:#e5e7eb;       /* light text */
    --muted:#94a3b8;      /* muted text */
    --accent:#16a34a;     /* bamboo green */
    --good:#22c55e;
    --bad:#ef4444;
    --headerH:132px;      /* fixed banner height */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  /* Fixed bamboo banner */
  .banner{
    position:fixed; top:0; left:0; right:0; z-index:50;
    background:linear-gradient(180deg, rgba(0,0,0,.95), rgba(0,0,0,.85));
    border-bottom:1px solid #111827;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    height:var(--headerH);
    padding:8px 12px;
    backdrop-filter: blur(6px);
  }
  .banner .logo{
    display:block; width:auto; max-height:84px;
    filter: drop-shadow(0 6px 18px rgba(22,163,74,.25));
  }
  .banner .title{
    margin-top:6px; color:#ffffff; font-weight:700; letter-spacing:.3px; text-align:center;
    text-shadow: 0 1px 2px rgba(0,0,0,.8);
  }
  .title.hidden{display:none}

  /* Sticky controls bar under banner */
  header.controls{
    position:sticky; top:var(--headerH); z-index:40;
    display:flex;gap:12px;align-items:center;justify-content:space-between;
    padding:12px 16px;background:rgba(15,23,42,.9);backdrop-filter:blur(6px);
    border-bottom:1px solid #1f2937;
  }

  .wrap{max-width:1100px;margin:calc(var(--headerH) + 60px) auto 18px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h2{margin:6px 0 12px 0}
  label{font-size:12px;color:var(--muted)}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
  .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  button{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .ghost{background:#0b1220;color:#fff;border:1px solid #374151}
  .danger{background:#ef4444}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
  .dot{width:10px;height:10px;border-radius:50%;background:#6b7280;border:1px solid #374151}
  .dot.live{background:#22c55e}
  pre{background:#0b1220;border:1px dashed #374151;border-radius:10px;padding:10px;max-height:160px;overflow:auto}
  canvas{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:8px}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .chip{border:1px solid #334155;background:#0b1220;color:#cbd5e1;border-radius:999px;padding:4px 8px;font-size:12px}
  .chip.ok{border-color:#14532d;color:#86efac;background:#052e16}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .banner{--headerH:118px} .banner .logo{max-height:72px} }
</style>
</head>
<body>

<!-- Fixed, centered banner with inline SVG bamboo -->
<div class="banner">
  <!-- Minimal bamboo in green gradient -->
  <svg class="logo" viewBox="0 0 512 128" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="ZenTrader Pro bamboo">
    <defs>
      <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
        <stop offset="0" stop-color="#22c55e"/>
        <stop offset="1" stop-color="#16a34a"/>
      </linearGradient>
    </defs>
    <!-- Stylized bamboo cluster -->
    <g transform="translate(16,10)" fill="url(#g)">
      <rect x="0" y="10" width="10" height="92" rx="3"/>
      <rect x="28" y="0" width="10" height="102" rx="3"/>
      <rect x="56" y="16" width="10" height="86" rx="3"/>
      <!-- nodes -->
      <rect x="0"  y="34" width="10" height="4" rx="2" opacity=".6"/>
      <rect x="28" y="28" width="10" height="4" rx="2" opacity=".6"/>
      <rect x="56" y="42" width="10" height="4" rx="2" opacity=".6"/>
      <rect x="0"  y="66" width="10" height="4" rx="2" opacity=".6"/>
      <rect x="28" y="60" width="10" height="4" rx="2" opacity=".6"/>
      <rect x="56" y="74" width="10" height="4" rx="2" opacity=".6"/>
      <!-- leaves -->
      <path d="M18 38c18-10 28-10 46-2-18 8-28 8-46 2Z" opacity=".85"/>
      <path d="M14 70c16-8 26-8 42-1-16 7-26 7-42 1Z" opacity=".85"/>
    </g>
    <!-- Title as vector text -->
    <g transform="translate(120,84)" fill="#ffffff">
      <text x="0" y="0" font-family="Segoe UI, Roboto, system-ui, Arial" font-size="42" font-weight="700" letter-spacing=".3px">ZenTrader Pro Dashboard</text>
    </g>
  </svg>

  <!-- Toggleable white text (use if you prefer text under the logo) -->
  <div id="titleText" class="title hidden">ZenTrader Pro Dashboard</div>
</div>

<!-- Sticky control bar under banner -->
<header class="controls">
  <div class="brand" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <label class="pill" style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="showTitleText"> Show title text under logo
    </label>

    <!-- Global commission settings -->
    <label class="pill" title="Per-side commission in dollars" style="display:flex;align-items:center;gap:6px">
      Per-side $ <input id="gcRateInput" type="number" step="0.01" style="width:90px;background:transparent;border:none;color:#e5e7eb" />
    </label>
    <label class="pill" title="If on, commission auto-calculates as (per-side * 2 * qty)" style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="gcAutoToggle" checked> Auto-apply commission
    </label>
  </div>

  <div class="toolbar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <select id="rangeSelect">
      <option value="all">All</option>
      <option value="day">Daily</option>
      <option value="week">Weekly</option>
      <option value="month">Monthly</option>
      <option value="year">Yearly</option>
    </select>
    <button class="ghost" id="exportBtn">Export CSV</button>
    <label class="pill"><input type="file" id="importFile" accept=".csv" style="display:none"><span id="importBtn" style="cursor:pointer">Import CSV</span></label>

    <div class="voice" style="display:flex;gap:8px;align-items:center">
      <select id="lang">
        <option value="en-US" selected>English (US)</option>
        <option value="en-GB">English (UK)</option>
        <option value="en-CA">English (CA)</option>
        <option value="en-AU">English (AU)</option>
      </select>
      <button id="primeMicBtn" class="ghost" title="Grant mic permission & warm audio">Prime Mic</button>
      <button id="voiceBtn">üé§ Voice</button><span class="dot" id="voiceDot"></span>
      <label class="pill" style="display:flex;align-items:center;gap:6px;margin-left:6px;">
        <input type="checkbox" id="keepAlive" checked> Keep mic alive
      </label>
      <label class="pill" style="display:flex;align-items:center;gap:6px;margin-left:6px;">
        <input type="checkbox" id="liveFill" checked> Live fill
      </label>
      <span class="pill" id="envPill">env: ?</span>
    </div>

    <label class="pill" style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="ttsToggle" checked>
      üîà Speak on review & save
    </label>
  </div>
</header>

<!-- ===== App body ===== -->
<div class="wrap">
  <div class="grid">
    <div class="card">
      <h2>Add / Edit Trade (All fields visible)</h2>
      <div class="row-3">
        <div><label>Date</label><input type="date" id="date"></div>
        <div><label>Symbol</label><input id="symbol" placeholder="ES, NQ, AAPL"></div>
        <div><label>Direction</label><select id="direction"><option>Long</option><option>Short</option></select></div>
      </div>
      <div class="row">
        <div><label>Qty</label><input id="qty" type="number" value="1" step="1" min="1"></div>
        <div><label>Entry Price</label><input id="entry" type="number" step="0.01" placeholder="e.g., 5000"></div>
        <div><label>Exit Price</label><input id="exit" type="number" step="0.01" placeholder="e.g., 5010"></div>
        <div><label>Commission ($ total)</label><input id="commission" type="number" step="0.01" value=""></div>
      </div>
      <div class="row-3">
        <div><label>Entry Time</label><input id="entryTime" type="time" placeholder="09:35"></div>
        <div><label>Exit Time</label><input id="exitTime" type="time" placeholder="10:12"></div>
        <div><label>Duration (min)</label><input id="duration" type="number" step="1" placeholder="auto"></div>
      </div>
      <div class="chips" id="chipBar"></div>
      <div class="actions">
        <button id="addBtn">Add trade</button>
        <button class="ghost" id="clearFormBtn">Clear form</button>
        <button class="danger" id="wipeBtn">Wipe all</button>
      </div>

      <div class="muted" style="margin-top:8px">
        Engine: <span id="vEngine">?</span> ‚Äî Status: <span id="vStatus">idle</span> ‚Äî <span id="vNote">Say ‚Äúsymbol ES, long, qty 1, entry 5000, exit 5010, date 2025-08-15 ‚Ä¶ review ‚Ä¶ confirm‚Äù.</span>
      </div>
      <pre id="vLog" style="margin-top:8px"></pre>
    </div>

    <div class="card">
      <h2>KPIs</h2>
      <div class="row-2">
        <div class="card" style="background:#0b1220"><div class="muted">Net P&L</div><div id="kNet" style="font-size:22px;"></div></div>
        <div class="card" style="background:#0b1220"><div class="muted">Win %</div><div id="kWin" style="font-size:22px;"></div></div>
      </div>
      <div class="row-2" style="margin-top:8px">
        <div class="card" style="background:#0b1220"><div class="muted">Avg Profit (Winners)</div><div id="kAvgWin" style="font-size:22px;"></div></div>
        <div class="card" style="background:#0b1220"><div class="muted">Cum. Commissions</div><div id="kComm" style="font-size:22px;"></div></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Profit Tracker ‚Äî P&L Trend</h2>
    <div class="row-2">
      <select id="granSelect">
        <option value="day">Daily</option>
        <option value="week">Weekly</option>
        <option value="month">Monthly</option>
        <option value="year">Yearly</option>
      </select>
      <select id="metricSelect">
        <option value="net">Net P&L</option>
        <option value="gross">Gross P&L</option>
        <option value="commission">Commissions</option>
      </select>
    </div>
    <canvas id="plChart" height="180"></canvas>
  </div>

  <div class="card">
    <h2>Commissions Over Time</h2>
    <canvas id="commChart" height="180"></canvas>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ---------- Helpers ---------- */
const log=(m)=>{const el=document.getElementById('vLog');el.textContent+=(new Date()).toLocaleTimeString()+': '+m+'\\n';el.scrollTop=el.scrollHeight;};
const setStatus=(s)=>{document.getElementById('vStatus').textContent=s;};
const setNote=(s)=>{document.getElementById('vNote').textContent=s;};
function fmt(x){return Number(x).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}
function signed(x){const s=Number(x);const c=s>=0?'good':'bad';return `<span class="pill ${c}">${s>=0?'+':''}${fmt(s)}</span>`;}
function parseNum(v){const n=Number(v);return isFinite(n)?n:0;}
function computeDurationMin(entryD,entryT,exitD,exitT){if(!entryT||!exitT)return'';const sd=entryD||new Date().toISOString().slice(0,10);const ed=exitD||sd;const start=new Date(sd+'T'+entryT);const end=new Date(ed+'T'+exitT);const ms=end-start;if(!isFinite(ms))return'';return Math.max(0,Math.round(ms/60000));}
function toTime24(s){if(!s)return null;s=s.replace(/\\./g,':').replace(/\\s+/g,'').toLowerCase();const m=s.match(/^(\\d{1,2}):?(\\d{2})?(am|pm)?$/);if(!m)return null;let h=parseInt(m[1],10),min=m[2]?parseInt(m[2],10):0;const ap=m[3];if(ap==='am'&&h===12)h=0;if(ap==='pm'&&h<12)h+=12;if(h>23||min>59)return null;return String(h).padStart(2,'0')+':'+String(min).padStart(2,'0');}
const MONTHS=['january','february','march','april','may','june','july','august','september','october','november','december'];
function parseDatePhrase(t){
  t=t.toLowerCase().trim();
  if(/\\btoday\\b/.test(t)) return new Date().toISOString().slice(0,10);
  if(/\\byesterday\\b/.test(t)) return new Date(Date.now()-86400000).toISOString().slice(0,10);
  let m=t.match(/\\b(\\d{4})-(\\d{2})-(\\d{2})\\b/);
  if(m){return `${m[1]}-${m[2]}-${m[3]}`;}
  m=t.match(/\\b(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{2,4})\\b/);
  if(m){
    let y=m[3]; if(y.length===2){y=(+y<70?'20'+y:'19'+y);}
    const mm=String(+m[1]).padStart(2,'0'); const dd=String(+m[2]).padStart(2,'0');
    return `${y}-${mm}-${dd}`;
  }
  const monthRegex=new RegExp(`\\b(${MONTHS.join('|')})\\s+(\\d{1,2})(?:,\\s*(\\d{4}))?`);
  m=t.match(monthRegex);
  if(m){
    const month=String(MONTHS.indexOf(m[1])+1).padStart(2,'0');
    const day=String(+m[2]).padStart(2,'0');
    const year=m[3]||String(new Date().getFullYear());
    return `${year}-${month}-${day}`;
  }
  const dayMonthRegex=new RegExp(`\\b(\\d{1,2})\\s+(${MONTHS.join('|')})(?:,\\s*(\\d{4}))?`);
  m=t.match(dayMonthRegex);
  if(m){
    const month=String(MONTHS.indexOf(m[2])+1).padStart(2,'0');
    const day=String(+m[1]).padStart(2,'0');
    const year=m[3]||String(new Date().getFullYear());
    return `${year}-${month}-${day}`;
  }
  return null;
}

/* ---------- Storage / settings ---------- */
const storeKey='zt_trades_v1',gcRateKey='zt_gc_rate',gcAutoKey='zt_gc_auto';
let trades=JSON.parse(localStorage.getItem(storeKey)||'[]');
function saveTrades(v){localStorage.setItem(storeKey,JSON.stringify(v));}
function loadGcRate(){const v=localStorage.getItem(gcRateKey);return v?Number(v):null;}
function saveGcRate(v){localStorage.setItem(gcRateKey,String(v));}
function loadGcAuto(){return localStorage.getItem(gcAutoKey)!=='false';}
function saveGcAuto(f){localStorage.setItem(gcAutoKey,f?'true':'false');}
let gcRate=loadGcRate(),gcAuto=loadGcAuto();
let lastAutoCommission=null;
function computeCommissionFromGlobal(qty){if(!gcAuto)return null;if(gcRate==null||!isFinite(gcRate))return null;const q=Number(qty);if(!isFinite(q)||q<=0)return null;return gcRate*2*q;}
function maybeAutoFillCommission(){const e=document.getElementById('commission'),q=document.getElementById('qty');if(!e||!q)return;const calc=computeCommissionFromGlobal(q.value);if(calc!=null){const cur=e.value;if(cur===''||(lastAutoCommission!=null&&Number(cur)===Number(lastAutoCommission))){e.value=calc.toFixed(2);lastAutoCommission=calc;}}}

/* ---------- KPIs / charts ---------- */
function filterByRange(arr,range){
  if(range==='all')return[...arr];
  const now=new Date();const start=new Date(now);
  if(range==='day'){start.setHours(0,0,0,0);return arr.filter(x=>new Date(x.date)>=start);}
  if(range==='week'){const dt=new Date(now);const day=(dt.getDay()+6)%7;dt.setDate(dt.getDate()-day);dt.setHours(0,0,0,0);return arr.filter(x=>new Date(x.date)>=dt);}
  if(range==='month'){start.setDate(1);start.setHours(0,0,0,0);return arr.filter(x=>new Date(x.date)>=start);}
  if(range==='year'){start.setMonth(0,1);start.setHours(0,0,0,0);return arr.filter(x=>new Date(x.date)>=start);}
  return arr;
}
function groupBy(arr,gran,metric='net'){
  const map=new Map();
  const keyFor=(t)=>{
    const d=new Date(t.date);
    if(gran==='day')return t.date;
    if(gran==='week'){const s=new Date(d);const day=(s.getDay()+6)%7;s.setDate(s.getDate()-day);s.setHours(0,0,0,0);return s.toISOString().slice(0,10);}
    if(gran==='month')return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
    if(gran==='year')return String(d.getFullYear());
    return t.date;
  };
  for(const t of arr){
    const k=keyFor(t);
    const v=metric==='commission'?t.commission:(metric==='gross'?t.gross:t.net);
    map.set(k,(map.get(k)||0)+v);
  }
  const labels=[...map.keys()].sort();
  return{labels,data:labels.map(k=>map.get(k))};
}
let plChart,commChart;
function drawCharts(filtered){
  const gran=document.getElementById('granSelect').value,metric=document.getElementById('metricSelect').value;
  const pl=groupBy(filtered,gran,metric);
  const cc=groupBy(filtered,gran,'commission');
  if(plChart)plChart.destroy();
  plChart=new Chart(document.getElementById('plChart'),{type:'line',data:{labels:pl.labels,datasets:[{label:metric.toUpperCase(),data:pl.data}]},options:{responsive:true,plugins:{legend:{display:true}},scales:{x:{ticks:{color:'#9ca3af'}},y:{ticks:{color:'#9ca3af'}}}}});
  if(commChart)commChart.destroy();
  commChart=new Chart(document.getElementById('commChart'),{type:'bar',data:{labels:cc.labels,datasets:[{label:'Commissions',data:cc.data}]},options:{responsive:true,plugins:{legend:{display:true}},scales:{x:{ticks:{color:'#9ca3af'}},y:{ticks:{color:'#9ca3af'}}}}});
}
function render(){
  const range=document.getElementById('rangeSelect').value;
  const filtered=filterByRange(trades,range);
  const net=filtered.reduce((a,b)=>a+b.net,0);
  const wins=filtered.filter(x=>x.net>0).length;
  const avgWin=wins?(filtered.filter(x=>x.net>0).reduce((a,b)=>a+b.net,0)/wins):0;
  const comm=filtered.reduce((a,b)=>a+b.commission,0);
  document.getElementById('kNet').innerHTML=signed(net);
  document.getElementById('kWin').textContent=(filtered.length?(wins/filtered.length*100).toFixed(1):'0.0')+'%';
  document.getElementById('kAvgWin').textContent=fmt(avgWin);
  document.getElementById('kComm').textContent=fmt(comm);
  drawCharts(filtered);
}
function addTrade(obj){
  let commissionVal=obj.commission;
  const qtyNum=parseInt(obj.qty||1,10);
  const commissionEl=document.getElementById('commission');
  const looksManual=commissionEl&&commissionEl.value!==''&&(lastAutoCommission==null||Number(commissionEl.value)!==Number(lastAutoCommission));
  if(!looksManual){const calc=computeCommissionFromGlobal(qtyNum);if(calc!=null)commissionVal=calc;}
  const t={
    id:crypto.randomUUID(),
    date:obj.date||new Date().toISOString().slice(0,10),
    symbol:(obj.symbol||'').trim().toUpperCase(),
    direction:obj.direction||'Long',
    qty:parseInt(obj.qty||1,10),
    entry:parseNum(obj.entry),
    exit:parseNum(obj.exit),
    commission:parseNum(commissionVal),
    entryTime:obj.entryTime||'',
    exitTime:obj.exitTime||'',
    duration:obj.duration||computeDurationMin(obj.date,obj.entryTime,obj.date,obj.exitTime)
  };
  const sign=t.direction==='Long'?1:-1;
  const pts=(t.exit-t.entry)*sign;
  const gross=pts*t.qty;
  const net=gross-t.commission;
  t.points=pts; t.gross=gross; t.net=net;
  trades.push(t); saveTrades(trades); render();
}

/* ---------- Chips ---------- */
function refreshChips(){
  const bar=document.getElementById('chipBar');
  const fmtChip=(k,v)=>`<span class="chip ${v?'ok':''}">${k}: ${v||'‚Äî'}</span>`;
  bar.innerHTML=[
    fmtChip('Date',document.getElementById('date').value),
    fmtChip('Symbol',document.getElementById('symbol').value),
    fmtChip('Dir',document.getElementById('direction').value),
    fmtChip('Qty',document.getElementById('qty').value),
    fmtChip('Entry',document.getElementById('entry').value),
    fmtChip('Exit',document.getElementById('exit').value),
    fmtChip('Comm',document.getElementById('commission').value),
    fmtChip('E.Time',document.getElementById('entryTime').value),
    fmtChip('X.Time',document.getElementById('exitTime').value),
  ].join(' ');
}
['date','symbol','direction','qty','entry','exit','commission','entryTime','exitTime'].forEach(id=>{
  document.addEventListener('input',(e)=>{ if(e.target && e.target.id===id) refreshChips();});
});

/* ---------- Voice ---------- */
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
document.getElementById('vEngine').textContent=SR?(window.SpeechRecognition?'SpeechRecognition':'webkitSpeechRecognition'):'None';
const voiceBtn=document.getElementById('voiceBtn'),voiceDot=document.getElementById('voiceDot'),keepAlive=document.getElementById('keepAlive'),liveFillCb=document.getElementById('liveFill'),envPill=document.getElementById('envPill'),primeBtn=document.getElementById('primeMicBtn');

envPill.textContent=(window.isSecureContext?'HTTPS':'NOT-HTTPS')+' ¬∑ SR:'+(SR?'yes':'no');

let rec=null,listening=false,wantListen=false,lastResultAt=0,watchdogId=null;
let draft={date:'',symbol:'',direction:'',qty:'',entry:'',exit:'',commission:'',entryTime:'',exitTime:'',duration:''};

async function primeMic(){try{const s=await navigator.mediaDevices.getUserMedia({audio:true});s.getTracks().forEach(t=>t.stop());log('Mic primed.');return true;}catch(e){log('Mic permission error: '+e.name+' '+e.message
	

