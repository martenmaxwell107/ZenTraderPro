<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ZenTrader Pro ‚Äî Dashboard</title>

<!-- Aggressive no-cache -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<meta name="color-scheme" content="dark light"/>
<meta name="theme-color" content="#0b0f17"/>
<style>
  :root{
    --bg:#0b0f17; --panel:#111827; --panel-2:#0e1524;
    --border:#22314a; --text:#e8eef7; --muted:#9db0c8;
    --gold:#d4af37; --gold-lite:#ffe08a; --accent:#4cc9f0;
    --green:#3fb37f; --red:#d45b6b;
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background:radial-gradient(900px 540px at 50% -180px,#182235 10%,var(--bg) 60%);
    padding-top:160px; /* JS syncs this to header height */
  }
  .btn{background:#0e1524;border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn:hover{border-color:#3c5f94}
  select{background:#0e1524;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px}

  /* Splash */
  .splash{position:fixed;inset:0;display:grid;place-items:center;z-index:2000;
    background:radial-gradient(1000px 700px at 40% -300px,#1a2740 0%,#0b0f17 60%);transition:opacity .35s ease}
  .splash.hidden{opacity:0;pointer-events:none}
  .splash-card{width:min(720px,92vw);background:linear-gradient(180deg,#121a2b,#0e1524);border:1px solid var(--border);
    border-radius:18px;padding:24px;box-shadow:0 20px 80px rgba(0,0,0,.45), inset 0 0 60px rgba(212,175,55,.06);text-align:center}

  /* Header */
  header.brand{position:fixed;left:0;right:0;top:0;z-index:1000;backdrop-filter:saturate(130%) blur(4px);
    background:linear-gradient(180deg,rgba(16,24,39,.95),rgba(11,15,23,.92));border-bottom:1px solid var(--border);padding:12px 16px 10px}
  .brand-inner{max-width:1200px;margin:0 auto;display:grid;place-items:center}
  .brand-title{margin:8px 0 0;font-weight:900;letter-spacing:.35px;font-size:22px;color:var(--gold-lite);text-shadow:0 1px 0 #7a5e12}
  .brand-sub{margin:2px 0 0;color:var(--muted);font-size:12px}
  .voice{display:flex;gap:10px;align-items:center;justify-content:center;margin:10px 0 0;flex-wrap:wrap}
  .status{color:var(--muted);font-size:12px}

  /* Layout */
  main{max-width:1200px;margin:18px auto;padding:0 16px 60px;display:grid;gap:16px;grid-template-columns:2fr 1fr}
  @media (max-width:980px){main{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 2px 18px rgba(0,0,0,.25)}
  .card h2{margin:0 0 12px;font-size:16px;color:var(--gold-lite)}
  .gold-outline{border:1px solid rgba(212,175,55,.35);box-shadow:inset 0 0 12px rgba(212,175,55,.15)}
  .form-grid{display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:center}
  label{color:var(--muted);font-size:13px}
  input,select,textarea{width:100%;background:var(--panel-2);color:var(--text);border:1px solid #283853;border-radius:10px;padding:10px;font-size:14px;outline:none;transition:border-color .2s,box-shadow .2s}
  input:focus,select:focus,textarea:focus{border-color:#3c5f94;box-shadow:0 0 0 3px rgba(76,201,240,.12)}
  textarea{min-height:80px;resize:vertical}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:8px 10px;text-align:left}
  th{background:var(--panel-2);color:var(--gold-lite);font-weight:700}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .stat{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center}
  .stat .v{font-size:20px;font-weight:800}
  .stat .l{color:var(--muted);font-size:12px}
  .chart{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:14px;display:grid;place-items:center}
  canvas{width:100%;height:260px;max-height:42vh}
  footer{color:var(--muted);font-size:12px;text-align:center;padding:24px 0}

  @media (prefers-reduced-motion: reduce){
    *{scroll-behavior:auto!important;animation:none!important;transition:none!important}
  }
</style>
<link id="favicon" rel="icon" type="image/svg+xml" href="">
</head>
<body>

<!-- Splash -->
<div id="splash" class="splash" role="dialog" aria-modal="true" aria-labelledby="splashTitle">
  <div class="splash-card">
    <div id="splashLogo" style="display:grid;place-items:center;margin-bottom:10px" aria-hidden="true"></div>
    <h1 id="splashTitle" style="color:var(--gold-lite);letter-spacing:.3px;margin:.2rem 0">ZenTrader Pro</h1>
    <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px">
      <select id="voiceSelect" title="Voice"><option>Loading voices‚Ä¶</option></select>
      <button id="testVoice" class="btn" type="button">üîä Test Voice</button>
      <button id="enterApp" class="btn" type="button">Enter Dashboard</button>
    </div>
    <div id="voiceHint" style="margin-top:10px;font-size:12px;color:var(--muted)"></div>
  </div>
</div>

<!-- Header -->
<header class="brand" role="banner">
  <div class="brand-inner">
    <div id="brandLogo" style="display:grid;place-items:center" aria-hidden="true"></div>
    <div class="brand-title">ZenTrader Pro</div>
    <div class="brand-sub">Voice Trading Console ‚Ä¢ v6.0</div>
    <div class="voice" role="group" aria-label="Voice controls">
      <button id="startVoice" class="btn" type="button">üéôÔ∏è Start Voice</button>
      <button id="stopVoice" class="btn" type="button">‚èπÔ∏è Stop</button>
      <span id="voiceStatus" class="status" aria-live="polite">Idle ‚Äî click Start Voice</span>
    </div>
  </div>
</header>

<!-- Main -->
<main role="main">
  <!-- Trade Entry -->
  <section class="card gold-outline" aria-labelledby="trade-entry">
    <h2 id="trade-entry">Trade Entry</h2>
    <div class="form-grid">
      <label for="ticker">Ticker</label><input id="ticker" inputmode="text" autocomplete="off" placeholder="e.g., SPY, ES, AAPL">
      <label for="side">Direction</label>
      <select id="side"><option value="">‚Äî Select ‚Äî</option><option>Long</option><option>Short</option></select>
      <label for="qty">Quantity</label><input id="qty" type="number" min="0" step="1" placeholder="e.g., 3">
      <label for="entry">Entry Price</label><input id="entry" type="number" min="0" step="0.01" placeholder="e.g., 492.35">
      <label for="exit">Exit Price</label><input id="exit" type="number" min="0" step="0.01" placeholder="e.g., 495.10">
      <label for="result">Win / Loss</label>
      <select id="result"><option value="">‚Äî Select ‚Äî</option><option>Win</option><option>Loss</option><option>BE</option></select>
      <label for="notes">Notes</label><textarea id="notes" placeholder="Reason for entry, setup, management‚Ä¶"></textarea>
    </div>
  </section>

  <!-- KPIs -->
  <section class="card gold-outline" aria-labelledby="kpis">
    <h2 id="kpis">KPIs</h2>
    <div class="stats">
      <div class="stat"><div class="v" id="k1">$0</div><div class="l">PnL (Today)</div></div>
      <div class="stat"><div class="v" id="k2">0%</div><div class="l">Win Rate</div></div>
      <div class="stat"><div class="v" id="k3">0</div><div class="l"># Trades</div></div>
      <div class="stat"><div class="v" id="k4">0.00</div><div class="l">Profit Factor</div></div>
    </div>
  </section>

  <!-- Recent Trades -->
  <section class="card gold-outline" aria-labelledby="recent-trades" style="grid-column:1/-1">
    <h2 id="recent-trades">Recent Trades</h2>
    <table aria-label="Recent trades">
      <thead><tr><th>Date</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Entry</th><th>Exit</th><th>Result</th><th>Notes</th></tr></thead>
      <tbody id="rows"><tr><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td></tr></tbody>
    </table>
  </section>

  <!-- Charts -->
  <section class="card gold-outline" aria-labelledby="charts" style="grid-column:1/-1">
    <h2 id="charts">Performance Charts</h2>
    <div class="chart" style="margin-bottom:14px"><canvas id="pnlLine" width="1000" height="260" aria-label="Equity curve"></canvas></div>
    <div class="chart" style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <canvas id="winLossDonut" height="240" aria-label="Win/Loss"></canvas>
      <canvas id="pnlBars" height="240" aria-label="Daily PnL"></canvas>
    </div>
  </section>
</main>

<footer role="contentinfo">
  <div id="footerLogo" style="display:grid;place-items:center;margin-bottom:6px" aria-hidden="true"></div>
  <div>¬© ZenTrader Pro</div>
</footer>

<script>
/* ===================== UTILITIES ===================== */
const $ = (sel)=>document.querySelector(sel);
function debounce(fn,ms){let t;return function(){const a=arguments;clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms);};}

/* ================== FORCED BRANDING (ALL-IN-ONE) ================== */
/* Antique, lopsided golden scales SVG with sunlight from upper-left */
function ZTP_ornateSVG(width){
  const w = width || 800;
  return `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 540" width="${w}" height="${Math.round(w*0.45)}" role="img" aria-label="ZenTrader Pro ornate golden balance logo">
  <defs>
    <linearGradient id="goldGrad" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0%" stop-color="#ffd063"/>
      <stop offset="45%" stop-color="#d4af37"/>
      <stop offset="70%" stop-color="#b88a1c"/>
      <stop offset="100%" stop-color="#7a5e12"/>
    </linearGradient>
    <!-- stronger highlight from upper-left -->
    <radialGradient id="shine" cx="0.06" cy="0.04" r="0.95">
      <stop offset="0%" stop-color="#ffffff" stop-opacity="0.70"/>
      <stop offset="40%" stop-color="#ffe08a" stop-opacity="0.30"/>
      <stop offset="100%" stop-color="#000000" stop-opacity="0"/>
    </radialGradient>
    <linearGradient id="cashGrad" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0%" stop-color="#6fdb8b"/>
      <stop offset="50%" stop-color="#3fb37f"/>
      <stop offset="100%" stop-color="#2e7c47"/>
    </linearGradient>
    <filter id="drop" x="-50%" y="-50%" width="200%" height="200%">
      <feDropShadow dx="0" dy="8" stdDeviation="8" flood-color="#000000" flood-opacity="0.55"/>
    </filter>
  </defs>

  <!-- Ornate base -->
  <g filter="url(#drop)">
    <path d="M240 480 C 380 430, 820 430, 960 480 L 980 510 C 820 520, 380 520, 220 510 Z"
          fill="url(#goldGrad)" stroke="#b88a1c" stroke-width="4"/>
    <path d="M260 470 C 410 420, 790 420, 940 470" fill="none" stroke="#ffe08a" stroke-opacity=".45" stroke-width="4"/>
    <path d="M240 480 C 380 430, 820 430, 960 480" fill="none" stroke="#7a5e12" stroke-opacity=".65" stroke-width="6"/>
  </g>

  <!-- Center column -->
  <g filter="url(#drop)">
    <rect x="578" y="240" width="44" height="190" rx="10" fill="url(#goldGrad)" stroke="#b88a1c" stroke-width="4"/>
    <circle cx="600" cy="236" r="26" fill="url(#goldGrad)" stroke="#b88a1c" stroke-width="4"/>
  </g>

  <!-- Cross arm (lopsided: left down, right up) -->
  <g filter="url(#drop)">
    <path d="M240 200 L 960 160" stroke="url(#goldGrad)" stroke-width="18" stroke-linecap="round"/>
    <path d="M240 200 L 960 160" stroke="#ffe08a" stroke-opacity=".35" stroke-width="6" stroke-linecap="round"/>
    <path d="M240 200 L 960 160" stroke="#7a5e12" stroke-opacity=".35" stroke-width="3" stroke-linecap="round"/>
  </g>

  <!-- Left chains (low) -->
  <g stroke="url(#goldGrad)" stroke-width="6" filter="url(#drop)">
    <line x1="340" y1="183" x2="340" y2="305"/>
    <line x1="420" y1="180" x2="420" y2="302"/>
    <line x1="380" y1="188" x2="380" y2="308"/>
  </g>

  <!-- Right chains (high) -->
  <g stroke="url(#goldGrad)" stroke-width="6" filter="url(#drop)">
    <line x1="820" y1="169" x2="820" y2="245"/>
    <line x1="880" y1="166" x2="880" y2="242"/>
    <line x1="850" y1="170" x2="850" y2="246"/>
  </g>

  <!-- Left pan (very low) with ornate Z -->
  <g filter="url(#drop)">
    <ellipse cx="380" cy="330" rx="135" ry="26" fill="#000" fill-opacity=".28"/>
    <g transform="translate(280,306)">
      <path d="M0 0 h200 a18 18 0 0 1 18 18 v8 a14 14 0 0 1 -14 14 h-208 a14 14 0 0 1 -14 -14 v-8 a18 18 0 0 1 18 -18z"
            fill="url(#goldGrad)" stroke="#b88a1c" stroke-width="4"/>
      <path d="M-10 10 h220" stroke="#ffe08a" stroke-opacity=".45" stroke-width="4"/>
    </g>
    <g transform="translate(380,300)">
      <circle r="42" fill="url(#goldGrad)" stroke="#b88a1c" stroke-width="4"/>
      <path d="M-20,-18 h40 l-44,36 h48" fill="none" stroke="#1a2233" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M-20,-18 h40 l-44,36 h48" fill="none" stroke="#ffe08a" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity=".9"/>
    </g>
  </g>

  <!-- Right pan (high) with crisp wrapped cash -->
  <g filter="url(#drop)">
    <ellipse cx="850" cy="270" rx="120" ry="22" fill="#000" fill-opacity=".22"/>
    <g transform="translate(760,246)">
      <path d="M0 0 h180 a16 16 0 0 1 16 16 v6 a12 12 0 0 1 -12 12 h-188 a12 12 0 0 1 -12 -12 v-6 a16 16 0 0 1 16 -16z"
            fill="url(#goldGrad)" stroke="#b88a1c" stroke-width="4"/>
      <path d="M-6 8 h192" stroke="#ffe08a" stroke-opacity=".45" stroke-width="3"/>
    </g>
    <g transform="translate(820,220)">
      <rect x="-58" y="-42" width="116" height="28" rx="4" fill="url(#cashGrad)" stroke="#153a25" stroke-width="3"/>
      <rect x="-60" y="-16" width="120" height="28" rx="4" fill="url(#cashGrad)" stroke="#153a25" stroke-width="3"/>
      <rect x="-62" y="10"  width="124" height="28" rx="4" fill="url(#cashGrad)" stroke="#153a25" stroke-width="3"/>
      <rect x="-18" y="-50" width="36" height="98" fill="#f6f6f6" stroke="#c9c9c9" stroke-width="2"/>
      <rect x="-16" y="-48" width="32" height="94" fill="#ffffff" opacity=".9"/>
    </g>
  </g>

  <!-- Sunlight from upper-left -->
  <circle cx="0" cy="0" r="520" fill="url(#shine)"/>
</svg>`;
}

/* Optional Base64 PNG override; leave empty to use the SVG above */
const ZTP_LOGO_PNG = "";

/* Cache-buster token */
const ZTP_CB = String(Date.now());

/* Inject logo; remove any stale <img> or previous logo */
function ZTP_mountLogo(selector, width){
  const host = document.querySelector(selector);
  if(!host) return;
  host.querySelectorAll('img, svg').forEach(n=>n.remove()); /* nuke stale assets */
  if (ZTP_LOGO_PNG){
    const img = new Image();
    img.alt = "ZenTrader Pro Logo";
    img.decoding = "async";
    img.loading = "lazy";
    img.style.width = (width||560) + "px";
    img.src = ZTP_LOGO_PNG + "#v=" + ZTP_CB; /* cache-bust */
    host.appendChild(img);
  } else {
    host.insertAdjacentHTML('afterbegin', ZTP_ornateSVG(width));
  }
}

/* Favicon from logo (cache-busted) */
function ZTP_setFavicon(){
  const link = document.getElementById('favicon') || (()=>{const l=document.createElement('link');l.id='favicon';l.rel='icon';document.head.appendChild(l);return l;})();
  if (ZTP_LOGO_PNG){
    link.href = ZTP_LOGO_PNG + "#v=" + ZTP_CB;
  } else {
    const svg = ZTP_ornateSVG(256);
    link.href = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg) + '#v=' + ZTP_CB;
  }
}

/* One-call branding */
function ZTP_applyBranding(){
  ZTP_mountLogo('#splashLogo', 560);
  ZTP_mountLogo('#brandLogo', 560);
  ZTP_mountLogo('#footerLogo', 280);
  ZTP_setFavicon();
}

/* ===================== DEMO DATA ===================== */
const demo={labels:["Mon","Tue","Wed","Thu","Fri","Mon","Tue","Wed","Thu","Fri"],pnlCum:[0,300,-120,450,200,680,540,900,750,1200],trades:[{result:"Win",pnl:220},{result:"Loss",pnl:-80},{result:"Win",pnl:160},{result:"Win",pnl:340},{result:"BE",pnl:0},{result:"Win",pnl:180},{result:"Loss",pnl:-120},{result:"Win",pnl:260},{result:"Win",pnl:140},{result:"Win",pnl:310}]};
function fmtMoney(v){return(v<0?"-$":"$")+Math.abs(v).toLocaleString()}
function calcKPIs(T){const n=T.length,w=T.filter(t=>t.result==="Win"),l=T.filter(t=>t.result==="Loss"),b=T.filter(t=>t.result==="BE");const wr=n?Math.round(w.length/n*100):0,tp=T.reduce((s,t)=>s+t.pnl,0);const gw=w.reduce((s,t)=>s+t.pnl,0),gl=Math.abs(l.reduce((s,t)=>s+t.pnl,0));const pf=gl?gw/gl:(gw?Infinity:0);return{n,winRate:wr,totalPnL:tp,profitFactor:pf,wins:w.length,losses:l.length,be:b.length};}
function updateKPIs(){const k=calcKPIs(demo.trades); $("#k1").textContent=fmtMoney(k.totalPnL); $("#k2").textContent=k.winRate+'%'; $("#k3").textContent=k.n; $("#k4").textContent=(Math.round(k.profitFactor*100)/100).toFixed(2);}

/* ===================== CHARTS ===================== */
function sizeCanvasForDPR(canvas){
  if(!canvas) return {ctx:null,W:0,H:0};
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const rect = canvas.getBoundingClientRect();
  const needW = Math.floor(rect.width * dpr);
  const needH = Math.floor(rect.height * dpr);
  if (canvas.width !== needW || canvas.height !== needH){ canvas.width = needW; canvas.height = needH; }
  return {ctx:canvas.getContext('2d'), W:canvas.width, H:canvas.height};
}
function grid(x,x1,y1,x2,y2,s){if(!x)return; x.strokeStyle='rgba(255,255,255,0.06)';x.lineWidth=1;for(let i=0;i<=s;i++){const y=y1+(y2-y1)*(i/s);x.beginPath();x.moveTo(x1,y);x.lineTo(x2,y);x.stroke();}}

function drawLine(c,labels,data){
  const {ctx:x,W,H}=sizeCanvasForDPR(c); if(!x) return;
  x.fillStyle='#0e1524';x.fillRect(0,0,W,H);
  const p={l:50,r:12,t:18,b:34},w=W-p.l-p.r,h=H-p.t-p.b;const M=Math.max(...data,0),m=Math.min(...data,0),R=(M-m)||1,y=v=>p.t+h-((v-m)/R)*h;
  grid(x,p.l,p.t,W-p.r,p.t+h,4);
  x.strokeStyle='#ffe08a';x.lineWidth=2;x.beginPath();
  data.forEach((v,i)=>{const X=p.l+w/(data.length-1)*i,Y=y(v);i?x.lineTo(X,Y):x.moveTo(X,Y)});x.stroke();
  x.fillStyle='#d4af37';data.forEach((v,i)=>{const X=p.l+w/(data.length-1)*i,Y=y(v);x.beginPath();x.arc(X,Y,3,0,6.283);x.fill()});
  x.fillStyle='#9db0c8';x.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial';x.fillText('PnL',8,16);x.fillText('Time ‚Üí',W/2-20,H-8);
}
function drawBars(c,labels,cum){
  const {ctx:x,W,H}=sizeCanvasForDPR(c); if(!x) return;
  x.fillStyle='#0e1524';x.fillRect(0,0,W,H);
  const p={l:40,r:12,t:14,b:34},w=W-p.l-p.r,h=H-p.t-p.b;const d=cum.map((v,i)=>i===0?v:cum[i]-cum[i-1]);const M=Math.max(...d,0),m=Math.min(...d,0),R=(M-m)||1,y=v=>p.t+h-((v-m)/R)*h,bw=w/d.length*.7;
  grid(x,p.l,p.t,W-p.r,p.t+h,4);
  d.forEach((v,i)=>{const X=p.l+w/d.length*i+(w/d.length-bw)/2,Y=y(v),Y0=y(0);x.fillStyle=v>=0?'rgba(63,179,127,.75)':'rgba(212,91,107,.75)';x.fillRect(X,Math.min(Y,Y0),bw,Math.abs(Y-Y0));x.strokeStyle=v>=0?'#3fb37f':'#d45b6b';x.strokeRect(X,Math.min(Y,Y0),bw,Math.abs(Y-Y0))});
  x.fillStyle='#9db0c8';x.font='11px system-ui,-apple-system,Segoe UI,Roboto,Arial';x.fillText('Daily PnL',8,16);x.fillText('Time ‚Üí',W/2-20,H-8);
}
function drawDonut(c,w,l,b){
  const {ctx:x,W,H}=sizeCanvasForDPR(c); if(!x) return;
  x.fillStyle='#0e1524';x.fillRect(0,0,W,H);
  const cx=W/2,cy=H/2,r=Math.min(W,H)/2-16,i=r*.6,t=w+l+b||1,P=[{v:w,color:'#3fb37f',label:'Wins'},{v:l,color:'#d45b6b',label:'Losses'},{v:b,color:'#9db0c8',label:'BE'}];
  let a=-Math.PI/2;P.forEach(p=>{const a1=a+(p.v/t)*Math.PI*2;x.beginPath();x.moveTo(cx,cy);x.arc(cx,cy,r,a,a1);x.closePath();x.fillStyle=p.color;x.fill();a=a1});
  x.globalCompositeOperation='destination-out';x.beginPath();x.arc(cx,cy,i,0,6.283);x.fill();x.globalCompositeOperation='source-over';
  x.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';x.fillStyle='#e8eef7';let ly=H-10,lx=10;P.forEach(p=>{x.fillStyle=p.color;x.fillRect(lx,ly-10,10,10);x.fillStyle='#e8eef7';x.fillText(p.label+': '+p.v,lx+16,ly);ly-=16});
}
function renderAll(){
  updateKPIs();
  drawLine($("#pnlLine"),demo.labels,demo.pnlCum);
  drawBars($("#pnlBars"),demo.labels,demo.pnlCum);
  const k=calcKPIs(demo.trades);
  drawDonut($("#winLossDonut"),k.wins,k.losses,k.be);
}
const renderAllDebounced = debounce(()=>{ requestAnimationFrame(renderAll); }, 60);

/* ================== VOICE (SULTRY BRITISH) ================== */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const synth = window.speechSynthesis;

function rankVoice(v){let s=0;if(/en-GB/i.test(v.lang))s+=1000;if(/female|woman|girl/i.test(v.name))s+=200;if(/Google|Microsoft|Apple/i.test(v.name))s+=50;if(/(Libby|Sonia|Hazel|Amy|Emma|Charlotte|Ellie|Mia|Aria|Jane|Lucy|Serena)/i.test(v.name))s+=120;return s;}
function getVoicesSorted(){try{const list=synth?.getVoices?.()||[];return list.slice().sort((a,b)=>rankVoice(b)-rankVoice(a));}catch{return[]}}

let voicesReady=false, voicesTries=0;
function populateVoices(){
  const list=getVoicesSorted();
  if(!list.length && voicesTries<24){ voicesTries++; setTimeout(populateVoices,220); return; }
  const hint = $('#voiceHint');
  const sel = $('#voiceSelect');
  if(!list.length){ if(hint) hint.textContent='No system voices available.'; return; }
  voicesReady=true;
  if(sel){
    sel.innerHTML="";
    list.forEach(v=>{const o=document.createElement('option');o.value=v.name;o.textContent=`${v.name} (${v.lang})`;sel.appendChild(o);});
    const saved=localStorage.getItem('ztpVoice');
    sel.value = (saved && list.some(v=>v.name===saved)) ? saved : list[0].name;
  }
  if(hint) hint.textContent='British female preferred. Your choice is saved.';
}
if(synth && typeof synth.onvoiceschanged!=='undefined'){ synth.onvoiceschanged=populateVoices; }
document.addEventListener('click', function once(){ if(!voicesReady) populateVoices(); document.removeEventListener('click', once, {passive:true}); }, {passive:true});
$('#voiceSelect')?.addEventListener('change',()=>localStorage.setItem('ztpVoice', $('#voiceSelect').value));

function currentVoice(){try{const name=$('#voiceSelect')?.value;const list=synth?.getVoices?.()||[];return list.find(v=>v.name===name)||list[0]||null;}catch{return null}}

/* Sexy / sultry preset (deeper + slower) */
const SULTRY = Object.freeze({ rate:0.82, pitch:0.80, volume:1.0 });
function speak(text, style=SULTRY){
  try{
    if(!synth || !('SpeechSynthesisUtterance' in window)) return;
    synth.cancel();
    const cleaned = String(text||'').replace(/\s+/g,' ').trim();
    if(!cleaned) return;
    const u=new SpeechSynthesisUtterance(cleaned);
    const v=currentVoice(); if(v) u.voice=v;
    u.rate = style.rate; u.pitch = style.pitch; u.volume = style.volume;
    synth.speak(u);
  }catch(e){ console.warn('TTS error',e); }
}
$('#testVoice')?.addEventListener('click',()=>{
  if(!(synth && (getVoicesSorted().length||0))) populateVoices();
  if(!synth){ alert('This browser does not support text-to-speech.'); return; }
  speak("Hello‚Ä¶ this is ZenTrader Pro. I‚Äôll guide you, in a calm, confident British tone.");
},{passive:true});
$('#enterApp')?.addEventListener('click',()=>{
  const s=$("#splash"); if(s){ s.classList.add('hidden'); s.setAttribute('aria-hidden','true'); }
  speak("Welcome to ZenTrader Pro. Let‚Äôs begin.");
},{passive:true});

/* ===== Speech recognition (manual start; wake words) ===== */
let rec=null,listening=false,armed=false,starting=false;
if(SR){
  rec=new SR(); rec.lang='en-US'; rec.continuous=true; rec.interimResults=true;
  rec.onresult=(e)=>{
    let finalText='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i],txt=r[0].transcript?.trim?.()||"";
      if(r.isFinal && txt) finalText+=' '+txt;
    }
    if(!finalText) return;
    const low=finalText.toLowerCase();
    if(!armed && (/\bhey[\s,.-]*then\b/.test(low)||/\bhey[\s,.-]*zen\b/.test(low))){
      armed=true; speak("Yes‚Ä¶ I‚Äôm listening.");
      const vs=$('#voiceStatus'); if(vs) vs.textContent='Awake. Try ‚Äúticker AAPL quantity three entry 492 point 35‚Äù.';
      return;
    }
    if(armed){ handleCommand(finalText); }
  };
  rec.onstart=()=>{listening=true;starting=false;const vs=$('#voiceStatus'); if(vs) vs.textContent='Listening‚Ä¶ Say ‚Äúhey then‚Äù or ‚Äúhey zen‚Äù‚Ä¶';};
  rec.onend = ()=>{listening=false;starting=false;const vs=$('#voiceStatus'); if(vs) vs.textContent='Stopped. Click Start Voice to resume.';};
  rec.onerror=(ev)=>{ starting=false; const vs=$('#voiceStatus');
    if(ev.error==='not-allowed'){ if(vs) vs.textContent='Mic blocked. Allow access in site settings, then press Start.'; }
    else if(ev.error==='aborted'){ if(vs) vs.textContent='Listening aborted.'; }
    else { if(vs) vs.textContent='Voice error: '+ev.error; }
  };
}
$('#startVoice')?.addEventListener('click',async ()=>{
  if(!rec){ const vs=$('#voiceStatus'); if(vs) vs.textContent='Speech recognition not supported in this browser.'; return; }
  if(listening||starting) return;
  try{
    if(navigator.permissions && navigator.permissions.query){
      try{ const p = await navigator.permissions.query({name:'microphone'}); if(p.state==='denied'){ const vs=$('#voiceStatus'); if(vs) vs.textContent='Microphone is blocked in site settings.'; } }catch(_){}
    }
    starting=true; rec.start();
  }catch(_){ starting=false; }
},{passive:true});
$('#stopVoice')?.addEventListener('click',()=>{ if(!rec) return; armed=false; try{ rec.stop(); }catch(_){} },{passive:true});

/* ===== Helpers: word-numbers & robust parsing ===== */
const WORD_NUM = Object.freeze({"zero":0,"one":1,"two":2,"three":3,"four":4,"five":5,"six":6,"seven":7,"eight":8,"nine":9,"ten":10,"eleven":11,"twelve":12,"thirteen":13,"fourteen":14,"fifteen":15,"sixteen":16,"seventeen":17,"eighteen":18,"nineteen":19,"twenty":20});
function wordsToNumberToken(s){return s.replace(/\b(zero|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty)\b/gi,(m)=>String(WORD_NUM[m.toLowerCase()]));}
function normalizeNumberText(s){return s.replace(/\bpoint\b/gi,'.').replace(/[^\d.]/g,'');}

function handleCommand(t){
  const raw=t.toLowerCase(); const s = wordsToNumberToken(raw);
  const tm=s.match(/\b(ticker|symbol)\s+([a-z]{1,6})\b/i); if(tm) $("#ticker").value=tm[2].toUpperCase();
  if(/\b(long|buy)\b/i.test(s))  $("#side").value='Long';
  if(/\b(short|sell)\b/i.test(s)) $("#side").value='Short';
  const qm=s.match(/\b(quantity|qty)\s+([a-z\d]{1,12})\b/i); if(qm){ const q=parseInt(wordsToNumberToken(qm[2]).replace(/[^\d]/g,''),10); if(Number.isFinite(q)) $("#qty").value=q; }
  const em=s.match(/\b(entry|enter|at)\s+([\d\s]*(?:point\s*\d+)?)\b/i); if(em){ const v=parseFloat(normalizeNumberText(em[2])); if(Number.isFinite(v)) $("#entry").value=v; }
  const xm=s.match(/\b(exit|target|take\s*profit)\s+([\d\s]*(?:point\s*\d+)?)\b/i); if(xm){ const v=parseFloat(normalizeNumberText(xm[2])); if(Number.isFinite(v)) $("#exit").value=v; }
  const nm=s.match(/\bnotes?\s+(.*)$/i); if(nm) $("#notes").value=nm[1];

  if(/\b(read\s*back|confirm|repeat)\b/i.test(s)){
    const out={ticker:$("#ticker").value||'‚Äî',side:$("#side").value||'‚Äî',qty:$("#qty").value||'‚Äî',entry:$("#entry").value||'‚Äî',exit:$("#exit").value||'‚Äî'};
    speak(`Ticker ${out.ticker}. Direction ${out.side}. Quantity ${out.qty}. Entry ${out.entry}. Exit ${out.exit}.`);
  }
}

/* ===== Sticky header spacing (no underlap) ===== */
const fixHeaderPadding = debounce(()=>{ try{ const h=document.querySelector('header.brand')?.getBoundingClientRect().height||160; document.body.style.paddingTop=Math.ceil(h)+'px'; }catch{} }, 40);
window.addEventListener('resize',fixHeaderPadding,{passive:true});
new MutationObserver(()=>fixHeaderPadding()).observe(document.documentElement,{subtree:true,childList:true,attributes:true,attributeFilter:['style','class']});

/* ===== Initialize everything ===== */
function init(){
  ZTP_applyBranding();
  fixHeaderPadding();
  renderAll();
  window.addEventListener('resize', renderAllDebounced, {passive:true});
}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init,{once:true});}else{init();}
</script>
</body>
</html>
	

	

	


	

	

	

	

	

	
